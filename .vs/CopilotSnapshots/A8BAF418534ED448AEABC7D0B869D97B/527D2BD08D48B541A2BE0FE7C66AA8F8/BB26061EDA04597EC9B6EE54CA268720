<?php
// configure cross-origin resource sharing headers
header("Access-Control-Allow-Origin: http://137.184.185.65");
header("Access-Control-Allow-Headers: Content-Type");
header("Access-Control-Allow-Methods: POST, GET, OPTIONS");

// handle preflight requests
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
  http_response_code(204);
  exit;
}

// helper functions for json handling
function sendJson($obj, $status = 200) {
  http_response_code($status);
  header('Content-Type: application/json; charset=utf-8');
  echo json_encode($obj);
  exit;
}

function getJsonBody() {
  $raw = file_get_contents('php://input');
  $data = json_decode($raw, true);
  if ($data === null && json_last_error() !== JSON_ERROR_NONE) {
    sendJson(['error' => 'Invalid JSON body'], 400);
  }
  return $data ?: [];
}

// read and validate input parameters
$in = getJsonBody();
$firstName = trim($in['firstName'] ?? '');
$lastName  = trim($in['lastName']  ?? '');
$login     = trim($in['login']     ?? '');
$password  = trim($in['password']  ?? '');

// validate required fields
if ($firstName === '' || $lastName === '' || $login === '' || $password === '') {
  sendJson(['error' => 'All fields are required.'], 400);
}

// establish database connection
$conn = new mysqli("localhost", "TheBeast", "WeLoveCOP4331", "Smallproject");
if ($conn->connect_error) {
  sendJson(['error' => 'Database connection failed'], 500);
}

// check for duplicate username
$stmt = $conn->prepare("SELECT ID FROM Users WHERE Login = ?");
$stmt->bind_param("s", $login);
$stmt->execute();
$stmt->store_result();
if ($stmt->num_rows > 0) {
  $stmt->close();
  $conn->close();
  sendJson(['error' => 'Username already exists.'], 409);
}
$stmt->close();

// hash password to match existing login behavior
$hashed = md5($password);

// insert new user record
$stmt = $conn->prepare("INSERT INTO Users (FirstName, LastName, Login, Password) VALUES (?, ?, ?, ?)");
$stmt->bind_param("ssss", $firstName, $lastName, $login, $hashed);

if ($stmt->execute()) {
  $newId = $stmt->insert_id;
  $stmt->close();
  $conn->close();
  // return response format consistent with api structure
  sendJson([
    'id'        => (int)$newId,
    'firstName' => $firstName,
    'lastName'  => $lastName,
    'error'     => ''
  ], 201);
} else {
  $err = $stmt->error;
  $stmt->close();
  $conn->close();
  sendJson(['error' => "Insert failed: $err"], 500);
}
