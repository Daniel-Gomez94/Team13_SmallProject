<?php
// Configure cross-origin resource sharing headers
header("Access-Control-Allow-Origin: http://137.184.185.65");
header("Access-Control-Allow-Headers: Content-Type");
header("Access-Control-Allow-Methods: POST, GET, OPTIONS");

// Handle preflight requests
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') { http_response_code(204); exit; }

// Helper functions for JSON handling
function sendJson($obj, $status = 200) {
  http_response_code($status);
  header('Content-Type: application/json; charset=utf-8');
  echo json_encode($obj);
  exit;
}
function getJsonBody() {
  $raw = file_get_contents('php://input');
  $data = json_decode($raw, true);
  if ($data === null && json_last_error() !== JSON_ERROR_NONE) {
    sendJson(['error' => 'Invalid JSON body'], 400);
  }
  return $data ?: [];
}

// Read and validate input parameters
$in = getJsonBody();
$userId    = $in['userId'] ?? null;
$firstName = isset($in['firstName']) ? trim($in['firstName']) : '';
$lastName  = isset($in['lastName'])  ? trim($in['lastName'])  : '';
$email     = isset($in['email'])     ? trim($in['email'])     : '';
$phone     = isset($in['phone'])     ? trim($in['phone'])     : '';

if (!is_numeric($userId) || $firstName === '' || $lastName === '') {
  sendJson(['error' => 'userId (int), firstName, and lastName are required'], 400);
}

// Establish database connection
$conn = new mysqli("localhost","TheBeast","WeLoveCOP4331","Smallproject");
if ($conn->connect_error) { sendJson(['error' => 'Database connection failed'], 500); }

// Insert new contact record
$stmt = $conn->prepare(
  "INSERT INTO Contacts (UserID, FirstName, LastName, Email, Phone)
   VALUES (?, ?, ?, ?, ?)"
);
if (!$stmt) { $conn->close(); sendJson(['error' => 'Prepare failed'], 500); }

$stmt->bind_param("issss", $userId, $firstName, $lastName, $email, $phone);
if (!$stmt->execute()) {
  $err = $stmt->error; $stmt->close(); $conn->close();
  sendJson(['error' => "Insert failed: $err"], 500);
}

$newId = $stmt->insert_id;
$stmt->close(); $conn->close();

sendJson([
  'id'        => (int)$newId,
  'userId'    => (int)$userId,
  'firstName' => $firstName,
  'lastName'  => $lastName,
  'email'     => $email,
  'phone'     => $phone,
  'error'     => ''
], 201);
