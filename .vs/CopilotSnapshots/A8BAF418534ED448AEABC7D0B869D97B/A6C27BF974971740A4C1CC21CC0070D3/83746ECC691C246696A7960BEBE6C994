<?php

ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// CORS
header("Access-Control-Allow-Origin: http://137.184.185.65");
header("Access-Control-Allow-Headers: Content-Type");
header("Access-Control-Allow-Methods: POST, GET, OPTIONS");

// Preflight
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
  http_response_code(204);
  exit;
}

// Helpers
function sendJson($obj, $status = 200) {
  http_response_code($status);
  header('Content-Type: application/json; charset=utf-8');
  echo json_encode($obj);
  exit;
}

function getJsonBody() {
  $raw = file_get_contents('php://input');
  $data = json_decode($raw, true);
  if ($data === null && json_last_error() !== JSON_ERROR_NONE) {
    sendJson(['id'=>0,'firstName'=>'','lastName'=>'','error'=>'Invalid JSON body'], 400);
  }
  return $data ?: [];
}

// Read input
$in = getJsonBody();
$login = trim($in['login'] ?? '');
$password = trim($in['password'] ?? '');
if ($login === '' || $password === '') {
  sendJson(['id'=>0,'firstName'=>'','lastName'=>'','error'=>'login and password required'], 400);
}

// DB
$conn = new mysqli("localhost", "TheBeast", "WeLoveCOP4331", "Smallproject");
if ($conn->connect_error) {
  sendJson(['id'=>0,'firstName'=>'','lastName'=>'','error'=>'DB connection failed'], 500);
}

// Hash incoming password to match CreateUsers.php behavior
$hashed = md5($password);

// Query
$stmt = $conn->prepare("SELECT ID, FirstName, LastName FROM Users WHERE Login = ? AND Password = ? LIMIT 1");
if (!$stmt) {
  sendJson(['id'=>0,'firstName'=>'','lastName'=>'','error'=>'Prepare failed'], 500);
}
$stmt->bind_param("ss", $login, $hashed);
$stmt->execute();
$result = $stmt->get_result();

if ($row = $result->fetch_assoc()) {
  $resp = [
    'id' => (int)$row['ID'],
    'firstName' => $row['FirstName'],
    'lastName' => $row['LastName'],
    'error' => ''
  ];
  $stmt->close();
  $conn->close();
  sendJson($resp, 200);
} else {
  $stmt->close();
  $conn->close();
  sendJson(['id'=>0,'firstName'=>'','lastName'=>'','error'=>'Invalid credentials'], 401);
}
