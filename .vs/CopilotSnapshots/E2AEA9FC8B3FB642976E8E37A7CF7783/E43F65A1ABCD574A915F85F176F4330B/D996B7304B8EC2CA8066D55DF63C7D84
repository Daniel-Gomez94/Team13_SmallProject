<?php
// CORS
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Headers: Content-Type");
header("Access-Control-Allow-Methods: POST, GET, OPTIONS"); // keeping POST for consistency

// Preflight
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') { http_response_code(204); exit; }

// Helpers
function sendJson($obj, $status = 200) {
  http_response_code($status);
  header('Content-Type: application/json; charset=utf-8');
  echo json_encode($obj);
  exit;
}
function getJsonBody() {
  $raw = file_get_contents('php://input');
  $data = json_decode($raw, true);
  if ($data === null && json_last_error() !== JSON_ERROR_NONE) {
    sendJson(['error' => 'Invalid JSON body'], 400);
  }
  return $data ?: [];
}

$in = getJsonBody();
$id        = $in['id']        ?? null;
$userId    = $in['userId']    ?? null;
$firstName = isset($in['firstName']) ? trim($in['firstName']) : '';
$lastName  = isset($in['lastName'])  ? trim($in['lastName'])  : '';
$email     = isset($in['email'])     ? trim($in['email'])     : '';
$phone     = isset($in['phone'])     ? trim($in['phone'])     : '';

if (!is_numeric($id) || !is_numeric($userId) || $firstName === '' || $lastName === '') {
  sendJson(['error' => 'id, userId (int), firstName, and lastName are required'], 400);
}

$conn = new mysqli("localhost", "TheBeast", "WeLoveCOP4331", "Smallproject");
if ($conn->connect_error) { sendJson(['error' => 'DB connection failed'], 500); }

// Check if contact exists and belongs to the user
$chk = $conn->prepare("SELECT ID FROM Contacts WHERE ID = ? AND UserID = ? LIMIT 1");
if (!$chk) { $conn->close(); sendJson(['error' => 'Prepare failed'], 500); }
$chk->bind_param("ii", $id, $userId);
$chk->execute();
$exists = $chk->get_result()->fetch_assoc();
$chk->close();
if (!$exists) {
  $conn->close();
  sendJson(['error' => 'Contact not found for this userId'], 404);
}

// Update contact
$upd = $conn->prepare("UPDATE Contacts SET FirstName = ?, LastName = ?, Email = ?, Phone = ? WHERE ID = ? AND UserID = ?");
if (!$upd) { $conn->close(); sendJson(['error' => 'Prepare failed'], 500); }
$upd->bind_param("ssssii", $firstName, $lastName, $email, $phone, $id, $userId);
if (!$upd->execute()) {
  $err = $upd->error; $upd->close(); $conn->close();
  sendJson(['error' => "Update failed: $err"], 500);
}
$affected = $upd->affected_rows;
$upd->close();
$conn->close();

// Return updated contact info
sendJson([
  'id'        => (int)$id,
  'userId'    => (int)$userId,
  'firstName' => $firstName,
  'lastName'  => $lastName,
  'email'     => $email,
  'phone'     => $phone,
  'error'     => ''
], 200);
