<?php
header("Access-Control-Allow-Origin: http://137.184.185.65");
header("Access-Control-Allow-Headers: Content-Type");
header("Access-Control-Allow-Methods: POST, GET, OPTIONS");

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') { http_response_code(204); exit; }

function sendJson($obj, $status = 200) {
  http_response_code($status);
  header('Content-Type: application/json; charset=utf-8');
  echo json_encode($obj);
  exit;
}
function getJsonBody() {
  $raw = file_get_contents('php://input');
  $data = json_decode($raw, true);
  if ($data === null && json_last_error() !== JSON_ERROR_NONE) {
    sendJson(['results'=>[], 'error'=>'Invalid JSON body'], 400);
  }
  return $data ?: [];
}

$in     = getJsonBody();
$userId = $in['userId'] ?? null;
$search = trim($in['search'] ?? '');

if (!is_numeric($userId)) {
  sendJson(['results'=>[], 'error'=>'userId (int) required'], 400);
}

$conn = new mysqli("localhost","TheBeast","WeLoveCOP4331","Smallproject");
if ($conn->connect_error) { sendJson(['results'=>[], 'error'=>'DB connection failed'], 500); }

// Updated SQL to search across first name, last name, email, and phone
$sql = "SELECT ID, FirstName, LastName, Email, Phone
        FROM Contacts
        WHERE (FirstName LIKE ? OR LastName LIKE ? OR Email LIKE ? OR Phone LIKE ?) AND UserID = ?
        ORDER BY LastName, FirstName";

$stmt = $conn->prepare($sql);
if (!$stmt) { $conn->close(); sendJson(['results'=>[], 'error'=>'Prepare failed'], 500); }

$like = "%".$search."%";
$stmt->bind_param("ssssi", $like, $like, $like, $like, $userId); // s,s,s,s,int
if (!$stmt->execute()) {
  $stmt->close(); $conn->close();
  sendJson(['results'=>[], 'error'=>'Query failed'], 500);
}

$res = $stmt->get_result();
$items = [];
while ($row = $res->fetch_assoc()) {
  $items[] = [
    'id'        => (int)$row['ID'],
    'firstName' => $row['FirstName'],
    'lastName'  => $row['LastName'],
    'email'     => $row['Email'],
    'phone'     => $row['Phone']
  ];
}
$stmt->close(); $conn->close();

sendJson(['results'=>$items, 'error'=>''], 200);
